<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Escala de Louvor</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,sans-serif;background:#f0f2f5;padding:16px;color:#222}
h1{text-align:center;margin:10px 0 20px;font-size:28px;font-weight:800;text-transform:uppercase}

.top-controls{display:flex;gap:10px;margin-bottom:20px}
.filters-toggle{flex:1;background:#222;color:#fff;border:none;border-radius:8px;height:45px;font-weight:700;cursor:pointer}
.past-toggle{width:45px;border:none;border-radius:8px;cursor:pointer}

.filters-box{display:none;background:#fff;border-radius:12px;padding:12px;margin-bottom:20px}
.filters-box.active{display:block}
.filters-box select{width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd}
.btn-clear{width:100%;padding:10px;border-radius:8px;border:none;background:#ffecec;color:#c00;font-weight:700}

.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:13px}
th{background:#222;color:#fff}

.cards{display:none}
.day-card{background:#fff;border-radius:14px;padding:14px;margin-bottom:12px}
.past-card{opacity:.6;filter:grayscale(.4)}
.date-pill{background:#222;color:#fff;padding:6px 14px;border-radius:999px;text-align:center;margin-bottom:10px;font-size:13px}

.block{background:#fafafa;border-radius:10px;padding:10px;margin-bottom:8px}
.block h4{margin:0 0 6px;font-size:13px;font-weight:800}
.label{font-weight:700}

a.whatsapp{color:#1a73e8;font-weight:700;text-decoration:none}
a.whatsapp:hover{text-decoration:underline}

@media(max-width:768px){
.table-wrap{display:none}
.cards{display:block}
}
</style>
</head>

<body>

<h1>Escala 2026</h1>

<div class="top-controls">
<button class="filters-toggle" id="btnFilters">Filtros</button>
<button class="past-toggle" id="btnPast">⏱</button>
</div>

<div class="filters-box" id="filters">
<select data-col="ANCIÃO"><option value="">Ancião</option></select>
<select data-col="REGENTE LOUVOR"><option value="">Regente</option></select>
<select data-col="EQUIPE LOUVOR"><option value="">Equipe</option></select>
<button class="btn-clear" id="btnClear">Limpar</button>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>DATA</th><th>DIA</th><th>ACOMP</th><th>REGENTE</th><th>EQUIPE</th><th>ES</th><th>ANCIÃO</th><th>PREGADOR</th><th>OBS</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<div class="cards" id="cards"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
/* ================= WHATSAPP ================= */
const whatsappLinks = {
  catherine:"https://wa.me/554391360091",
  luiz:"https://wa.me/5543999609883",
  andre:"https://wa.me/5543920008370",
  fabricio:"https://wa.me/554396670568",
  giovana:"https://wa.me/5543984876102",
  emily:"https://wa.me/554391240309",
  nilsinho:"https://wa.me/554396557195",
  suellen:"https://wa.me/554398488720",
  suelen:"https://wa.me/554398488720",
  marcos:"https://wa.me/554396589712",
  ricardo:"https://wa.me/554396158431",
  dulcineia:"https://wa.me/554396339940",
  enoque:"https://wa.me/554396598684",
  adelmo:"https://wa.me/554399512450"
};

function normalizar(t){
  return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();
}

function linkificar(txt){
  if(!txt) return "";
  let partes = txt.split(/(\s|,)/);
  for(let i=0;i<partes.length;i++){
    let k = normalizar(partes[i]);
    if(whatsappLinks[k]){
      partes[i]=`<a class="whatsapp" href="${whatsappLinks[k]}" target="_blank">${partes[i]}</a>`;
    }
  }
  return partes.join("");
}

/* ================= CSV ================= */
let dados=[];

function parseDate(d){
  const p=d.split("/");
  return new Date(p[2],p[1]-1,p[0]);
}
function isPast(d){
  const t=new Date();t.setHours(0,0,0,0);
  return parseDate(d)<t;
}

async function carregar(){
  const r=await fetch("atual.csv?t="+Date.now());
  const t=await r.text();
  dados=Papa.parse(t,{header:true,skipEmptyLines:true}).data;
  render(dados);
  filtros();
}

function render(lista){
  const tb=document.getElementById("tableBody");
  const cards=document.getElementById("cards");
  tb.innerHTML="";cards.innerHTML="";
  lista.forEach(d=>{
    const tr=document.createElement("tr");
    if(isPast(d.DATA)) tr.style.opacity=.5;
    tr.innerHTML=`
<td>${d.DATA}</td>
<td>${d["DIA SEMANA"]}</td>
<td>${d.ACOMP||""}</td>
<td>${linkificar(d["REGENTE LOUVOR"])}</td>
<td>${linkificar(d["EQUIPE LOUVOR"])}</td>
<td>${d["LOUVORES ES"]||""}</td>
<td>${linkificar(d["ANCIÃO"])}</td>
<td>${linkificar(d["PREGADOR"])}</td>
<td>${d.OBS||""}</td>`;
    tb.appendChild(tr);

    const c=document.createElement("div");
    c.className="day-card"+(isPast(d.DATA)?" past-card":"");
    c.innerHTML=`
<div class="date-pill">${d.DATA} — ${d["DIA SEMANA"]}</div>
<div class="block"><h4>Equipe</h4>${linkificar(d["EQUIPE LOUVOR"])}</div>
<div class="block"><h4>ES</h4>${d["LOUVORES ES"]||""}</div>
<div class="block"><h4>Liderança</h4>
<span class="label">Ancião:</span> ${linkificar(d["ANCIÃO"])}<br>
<span class="label">Pregador:</span> ${linkificar(d["PREGADOR"])}
</div>
${d.OBS?`<div class="block"><h4>Obs</h4>${d.OBS}</div>`:""}
`;
    cards.appendChild(c);
  });
}

function filtros(){
  document.querySelectorAll("#filters select").forEach(s=>{
    const c=s.dataset.col;
    [...new Set(dados.map(d=>d[c]).filter(Boolean))].sort().forEach(v=>{
      const o=document.createElement("option");
      o.value=v;o.textContent=v;s.appendChild(o);
    });
    s.onchange=()=>filtrar();
  });
}

function filtrar(){
  let f=[...dados];
  document.querySelectorAll("#filters select").forEach(s=>{
    if(s.value) f=f.filter(d=>d[s.dataset.col]===s.value);
  });
  render(f);
}

/* ================= UI ================= */
document.getElementById("btnFilters").onclick=()=>document.getElementById("filters").classList.toggle("active");
document.getElementById("btnClear").onclick=()=>{document.querySelectorAll("#filters select").forEach(s=>s.value="");render(dados);};

carregar();
</script>

</body>
</html>
